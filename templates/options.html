{% extends "base.html" %}
{% block title %}Options · Legal Time Tracker{% endblock %}

{% block content %}
<main class="container narrow">
  <form method="post" action="{{ url_for('options') }}" class="card" id="options-form" novalidate>
    <h1>Options</h1>

    <!-- User & Email Settings (compact) -->
    <section class="card soft">
      <h2 style="margin-top:0">User &amp; Email Settings</h2>

      <div class="grid two gap-lg">
        <label class="row align-center gap">
          <input type="checkbox" name="auto_expand" value="1" {% if settings.auto_expand == 1 %}checked{% endif %}>
          Expand common abbreviations in descriptions (e.g., “OP” → “Opposing Counsel”)
        </label>

        <label>Admin Email (optional)
          <input type="email" name="admin_email" value="{{ settings.admin_email or '' }}" placeholder="alerts, exports, etc.">
        </label>

        <label>Manager Email (optional)
          <input type="email" name="manager_email" value="{{ settings.manager_email or '' }}" placeholder="optional CC">
        </label>
      </div>

      <!-- Collapsible advanced email transport -->
      <details class="mt-md">
        <summary class="summary-link">Email transport (advanced)</summary>
        <div class="grid three mt-sm">
          <label>SMTP Server
            <input name="smtp_server" value="{{ settings.smtp_server or '' }}" placeholder="smtp.office365.com">
          </label>
          <label>Port
            <input name="smtp_port" value="{{ settings.smtp_port or '' }}" placeholder="587">
          </label>
          <label class="row align-center gap">
            <input type="checkbox" name="smtp_use_tls" value="1" {% if settings.smtp_use_tls == 1 %}checked{% endif %}>
            Use TLS
          </label>
          <label>SMTP Username
            <input name="smtp_username" value="{{ settings.smtp_username or '' }}" placeholder="you@firm.com">
          </label>
          <label>From Address
            <input name="smtp_from" value="{{ settings.smtp_from or '' }}" placeholder="you@firm.com">
          </label>
        </div>
      </details>
    </section>

    <!-- Master Lists -->
    <section class="card soft">
      <h2 style="margin-top:0">Master Lists</h2>
      <p class="muted" style="margin-top:0">
        These lists feed the drop-downs on the <em>New Entry</em> screen. Keep them short &amp; clean—archive or remove
        stale items so selecting during entry stays fast. Use the box below each list to <strong>add items</strong>.
        The dropdown of suggestions appears only when you click inside the box.
      </p>

      <!-- Clients -->
      <div class="list-editor" data-name="clients" data-items='{{ (settings.clients or [])|tojson }}'>
        <div class="row space-between align-center">
          <h3 class="h4" style="margin:0">Clients</h3>
          <div class="row gap">
            <button type="button" class="btn small ghost js-sort" data-target="clients">A→Z</button>
            <button type="button" class="btn small danger ghost js-clear" data-target="clients">Clear</button>
          </div>
        </div>

        <div class="token-scroll" id="tokens-clients"></div>

        <div class="adder">
          <input type="text" class="adder-input" id="add-clients" placeholder="Click here to add a new client">
          <div class="adder-dropdown" id="dd-clients" hidden></div>
        </div>

        <!-- backend payload (newline separated) -->
        <textarea name="clients" id="clients_text" hidden></textarea>
      </div>

      <!-- Matters -->
      <div class="list-editor" data-name="matters" data-items='{{ (settings.matters or [])|tojson }}'>
        <div class="row space-between align-center">
          <h3 class="h4" style="margin:0">Matters</h3>
          <div class="row gap">
            <button type="button" class="btn small ghost js-sort" data-target="matters">A→Z</button>
            <button type="button" class="btn small danger ghost js-clear" data-target="matters">Clear</button>
          </div>
        </div>

        <div class="token-scroll" id="tokens-matters"></div>

        <div class="adder">
          <input type="text" class="adder-input" id="add-matters" placeholder="Click here to add a new matter">
          <div class="adder-dropdown" id="dd-matters" hidden></div>
        </div>

        <textarea name="matters" id="matters_text" hidden></textarea>
      </div>

      <!-- Rates -->
      <div class="list-editor" data-name="rates" data-items='{{ (settings.rates or [])|tojson }}'>
        <div class="row space-between align-center">
          <h3 class="h4" style="margin:0">Rates</h3>
          <div class="row gap">
            <button type="button" class="btn small ghost js-sort" data-target="rates">A→Z</button>
            <button type="button" class="btn small danger ghost js-clear" data-target="rates">Clear</button>
          </div>
        </div>

        <div class="token-scroll" id="tokens-rates"></div>

        <div class="adder">
          <input type="text" class="adder-input" id="add-rates" placeholder="Click here to add a new rate (e.g., 350)">
          <div class="adder-dropdown" id="dd-rates" hidden></div>
        </div>

        <textarea name="rates" id="rates_text" hidden></textarea>
      </div>
    </section>

    <div class="row space-between" style="margin-top:.75rem">
      <a class="btn" href="{{ url_for('entries') }}">Back</a>
      <button type="submit" class="btn primary">Save Settings</button>
    </div>
  </form>
</main>

<!-- Minimal scoped styles (you can move these to style.css) -->
<style>
  .grid.two { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; }
  .grid.three { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; }
  @media (max-width:900px){ .grid.two, .grid.three { grid-template-columns: 1fr; } }

  .summary-link { cursor:pointer; user-select:none; }
  details > summary { list-style: none; }
  details > summary::-webkit-details-marker { display:none; }

  .list-editor { margin-top:16px; border:1px solid var(--border, #e5e7eb); border-radius:10px; padding:12px; background:#fafafa; }
  .token-scroll { display:flex; flex-wrap: wrap; gap:8px; max-height:120px; overflow:auto; padding:6px; background:#fff; border:1px dashed #e0e0e0; border-radius:8px; }
  .token { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:9999px; background:#eef2ff; }
  .token .x { border:none; background:transparent; cursor:pointer; font-size:14px; line-height:1; }
  .adder { position:relative; margin-top:10px; }
  .adder-input { width:100%; padding:.6rem .8rem; border:1px solid #ddd; border-radius:8px; background:#fff; }
  .adder-dropdown { position:absolute; left:0; right:0; top:calc(100% + 6px); z-index:5; background:#fff; border:1px solid #ddd; border-radius:8px; max-height:220px; overflow:auto; box-shadow:0 6px 18px rgba(0,0,0,.07); }
  .dd-item { padding:.5rem .75rem; cursor:pointer; }
  .dd-item:hover { background:#f6f8ff; }
  .mt-sm{ margin-top:8px; } .mt-md{ margin-top:12px; }
  .gap-lg { gap:16px; }
  .ghost { background:transparent; border-color:transparent; }
</style>

<script>
  // Tiny list editor for Clients/Matters/Rates
  (function(){
    function normalize(s){ return (s||'').trim(); }
    function uniqPush(arr, v){
      v = normalize(v);
      if(!v) return false;
      const exists = arr.some(x => x.toLowerCase() === v.toLowerCase());
      if(!exists) { arr.push(v); return true; }
      return false;
    }
    function renderTokens(name, state){
      const wrap = document.getElementById('tokens-'+name);
      wrap.innerHTML = '';
      state.items.forEach((v, idx) => {
        const chip = document.createElement('span');
        chip.className = 'token';
        chip.textContent = v;
        const x = document.createElement('button');
        x.type = 'button';
        x.className = 'x';
        x.setAttribute('aria-label','Remove');
        x.textContent = '×';
        x.addEventListener('click', ()=>{ state.items.splice(idx,1); sync(name, state); });
        chip.appendChild(x);
        wrap.appendChild(chip);
      });
    }
    function renderDropdown(name, state){
      const dd = document.getElementById('dd-'+name);
      dd.innerHTML = '';
      // Use current items as suggestions; only show on click/focus
      state.items.slice().sort((a,b)=>a.localeCompare(b)).forEach(v=>{
        const row = document.createElement('div');
        row.className = 'dd-item';
        row.textContent = v;
        row.addEventListener('click', ()=>{
          // Selecting an existing item again doesn't add duplicate; close dropdown
          dd.hidden = true;
          document.getElementById('add-'+name).value = v;
          document.getElementById('add-'+name).focus();
        });
        dd.appendChild(row);
      });
    }
    function syncTextarea(name, state){
      document.getElementById(name+'_text').value = state.items.join('\n');
    }
    function sync(name, state){
      renderTokens(name, state);
      renderDropdown(name, state);
      syncTextarea(name, state);
    }
    function attachEditor(el){
      const name = el.dataset.name;
      const initial = JSON.parse(el.dataset.items || '[]');
      const state = { items: initial.filter(Boolean) };

      const input = document.getElementById('add-'+name);
      const dropdown = document.getElementById('dd-'+name);

      // Show dropdown only when clicking/focusing inside the box
      input.addEventListener('focus', ()=>{ dropdown.hidden = false; });
      input.addEventListener('click',  ()=>{ dropdown.hidden = false; });
      document.addEventListener('click', (e)=>{
        if (!el.contains(e.target)) dropdown.hidden = true;
      });

      input.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter') {
          e.preventDefault();
          const v = normalize(input.value);
          if (uniqPush(state.items, v)) {
            sync(name, state);
          }
          input.value = '';
          dropdown.hidden = true;
        }
      });

      // Buttons
      el.querySelector('.js-sort')?.addEventListener('click', ()=>{
        state.items.sort((a,b)=>a.localeCompare(b));
        sync(name, state);
      });
      el.querySelector('.js-clear')?.addEventListener('click', ()=>{
        if (confirm('Clear all items?')) {
          state.items = [];
          sync(name, state);
        }
      });

      // Initial render
      sync(name, state);
    }

    document.querySelectorAll('.list-editor').forEach(attachEditor);
  })();
</script>
{% endblock %}
