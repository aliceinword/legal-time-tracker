{% extends "base.html" %}
{% block title %}Admin · Users · Legal Time Tracker{% endblock %}
{% block content %}
<main class="container" id="admin-users">

  {% with msgs = get_flashed_messages(with_categories=true) %}
    {% if msgs %}
      <div class="flash">
        {% for cat, m in msgs %}<div class="flash-item {{ cat }}">{{ m }}</div>{% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Users table -->
  <div class="card">
    <h1>Users</h1>

    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Email</th>
            <th>Admin</th>
            <th class="actions">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr>
            <td data-label="ID">{{ u.id }}</td>
            <td data-label="Username">{{ u.name }}</td>
            <td data-label="Email">{{ u.email }}</td>
            <td data-label="Admin">{{ 'Yes' if u.is_admin else 'No' }}</td>
            <td class="actions">
              <form action="{{ url_for('admin_users_delete') }}" method="post" style="display:inline"
                    onsubmit="return confirm('Delete user {{ u.name }}? This cannot be undone.')">
                <input type="hidden" name="user_id" value="{{ u.id }}">
                <button class="btn danger small" type="submit">Delete</button>
              </form>
              <button class="btn small" type="button" onclick="toggleReset('{{ u.id }}')">Reset Password</button>
            </td>
          </tr>
          <tr id="reset-row-{{ u.id }}" style="display:none">
            <td colspan="5">
              <form action="{{ url_for('admin_users_reset_password') }}" method="post" class="row gap">
                <input type="hidden" name="user_id" value="{{ u.id }}">
                <input type="password" name="new_password" placeholder="New password" autocomplete="new-password" required>
                <input type="password" name="new_password2" placeholder="Confirm password" autocomplete="new-password" required>
                <button class="btn primary small" type="submit">Save</button>
                <button class="btn small" type="button" onclick="toggleReset('{{ u.id }}')">Cancel</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Add user -->
  <div class="card">
    <h2>Add User</h2>
    <form action="{{ url_for('admin_users_add') }}" method="post" class="grid three">
      <label>Username
        <input name="name" required>
      </label>
      <label>Email
        <input type="email" name="email" required>
      </label>
      <label>Password
        <input type="password" name="password" autocomplete="new-password" required>
      </label>

      <!-- Admin toggle (stays snug to text via .checkline) -->
      <label class="checkline">
        <input type="checkbox" name="is_admin" value="1">
        <span>Admin</span>
      </label>

      <div class="row end" style="grid-column:1/-1">
        <button class="btn primary" type="submit">Create</button>
      </div>
    </form>
  </div>
</main>

<script>
  function toggleReset(id) {
    const row = document.getElementById('reset-row-' + id);
    if (!row) return;
    row.style.display = (row.style.display === 'none' || row.style.display === '') ? 'table-row' : 'none';
  }
</script>
{% endblock %}
