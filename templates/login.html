{% extends "base.html" %}
{% block title %}Sign in Â· Legal Time Tracker{% endblock %}

{% block content %}
<main class="auth-page">
  {% with msgs = get_flashed_messages(with_categories=true) %}
    {% if msgs %}
      <div class="flash" style="margin-bottom:16px">
        {% for cat, m in msgs %}<div class="flash-item {{ cat }}">{{ m }}</div>{% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="card auth-card">
    <header class="auth-header">
      <h1>Sign in</h1>
      <p class="sub">Use your username or email and password.</p>
    </header>

    <form action="{{ url_for('login') }}" method="post" class="auth-form" novalidate>
      <label>Username or Email
        <input type="text" name="username" autocomplete="username"
               placeholder="e.g. Law or law@local" required autofocus>
      </label>

      <label>Password
        <div class="input-with-button">
          <input type="password" id="password" name="password"
                 autocomplete="current-password" placeholder="Your password" required>
          <button type="button" class="btn small ghost" onclick="togglePw()" aria-label="Show password">Show</button>
        </div>
      </label>

      <div class="row space-between" style="margin:8px 0 2px">
        <label class="row gap" style="margin:0">
          <input type="checkbox" name="remember" value="1">
          <span>Remember me</span>
        </label>
        <a class="btn link" href="{{ url_for('register') }}">Create account</a>
      </div>

      <button class="btn primary wide" type="submit">Sign in</button>
    </form>
  </div>

  {# Success modal shown only after redirect with ?created=1 #}
  {% if request.args.get('created') %}
  <div id="acct-modal" class="modal" style="display:flex">
    <div class="modal-card">
      <h3>Account created ðŸŽ‰</h3>
      <p>Your account for <strong>{{ request.args.get('email') }}</strong> is ready.</p>
      <p>Please save your login details in a safe place:</p>
      <ul>
        <li><strong>Username:</strong> <code>{{ request.args.get('username') }}</code></li>
        <li><strong>Email:</strong> <code>{{ request.args.get('email') }}</code></li>
        <li><strong>Password:</strong> the one you just set</li>
      </ul>
      <div class="row end" style="gap:8px">
        <button class="btn" id="copy-cred" type="button">Copy details</button>
        <button class="btn primary" id="modal-close" type="button">Got it</button>
      </div>
    </div>
  </div>
  {% endif %}
</main>

<script>
  function togglePw(){
    const el = document.getElementById('password');
    el.type = (el.type === 'password') ? 'text' : 'password';
  }

  (function(){
    const modal = document.getElementById('acct-modal');
    if(!modal) return;

    const closeBtn = document.getElementById('modal-close');
    const copyBtn  = document.getElementById('copy-cred');

    if (closeBtn) closeBtn.onclick = () => {
      const url = new URL(window.location);
      url.searchParams.delete('created');
      url.searchParams.delete('username');
      url.searchParams.delete('email');
      window.location.replace(url.toString());
    };

    if (copyBtn) copyBtn.onclick = () => {
      const u = "{{ request.args.get('username','')|e }}";
      const e = "{{ request.args.get('email','')|e }}";
      const text = `Username: ${u}\nEmail: ${e}\n(Password: you set it)`;
      navigator.clipboard.writeText(text).then(()=>{
        copyBtn.textContent = 'Copied';
        setTimeout(()=>copyBtn.textContent='Copy details', 1400);
      });
    };
  })();
</script>
{% endblock %}
