<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- Viewport (single, corrected) -->
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <title>{% block title %}Legal Time Tracker{% endblock %}</title>

  <!-- PWA Meta / Icons -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <meta name="theme-color" content="#007bff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icon-192.png') }}">
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">

  <!-- App CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- Mobile CSS (corrected broken tag) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='mobile.css') }}">

  <!-- Offline JS (deferred so it doesn't block rendering) -->
  <script defer src="{{ url_for('static', filename='offline.js') }}"></script>

  <!-- PWA Registration (uses static sw.js path) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        const swUrl = "{{ url_for('static', filename='sw.js') }}";
        navigator.serviceWorker.register(swUrl)
          .then(() => console.log('Service Worker registered'))
          .catch(err => console.log('Service Worker registration failed', err));
      });
    }
  </script>
</head>
<body class="theme" data-theme="light">
  <header class="topbar">
    <div class="brand">
      <a href="{{ url_for('entries') }}">Legal Time Tracker</a>
    </div>
    <nav class="nav">
      {% if current_user.is_authenticated %}
        <a href="{{ url_for('entries') }}">Entries</a>
        <a href="{{ url_for('entry') }}">New Entry</a>
        <a href="{{ url_for('options') }}">Options</a>
        {% if current_user.is_admin %}
          <a href="{{ url_for('admin_users') }}">Admin</a>
        {% endif %}
        <span class="spacer"></span>
        <span class="user">ðŸ‘¤ {{ current_user.name }}</span>
        <a class="btn link" href="{{ url_for('logout') }}">Logout</a>
      {% else %}
        <span class="spacer"></span>
        <a class="btn" href="{{ url_for('login') }}">Login</a>
        <a class="btn primary" href="{{ url_for('register') }}">Create Account</a>
      {% endif %}
      <button id="theme-toggle" class="btn icon" type="button" title="Toggle theme">ðŸŒ“</button>
    </nav>
  </header>

  <main class="container">
    {% with msgs = get_flashed_messages(with_categories=true) %}
      {% if msgs %}
        <div class="flash">
          {% for category, m in msgs %}
            <div class="flash-item {{ category }}">{{ m }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  <script>
    // Theme toggle (kept here so it runs after body loads)
    (function () {
      const key = 'lt_theme';
      const body = document.body;
      const saved = localStorage.getItem(key);
      if (saved) {
        body.dataset.theme = saved;
      } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        body.dataset.theme = 'dark';
      }
      document.getElementById('theme-toggle')?.addEventListener('click', () => {
        body.dataset.theme = (body.dataset.theme === 'dark') ? 'light' : 'dark';
        localStorage.setItem(key, body.dataset.theme);
      });
    })();
  </script>
</body>
</html>
